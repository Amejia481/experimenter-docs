(self.webpackChunkexperimenter_docs=self.webpackChunkexperimenter_docs||[]).push([[634],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var u=a.createContext({}),l=function(e){var t=a.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(u.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,u=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=l(n),m=r,f=d["".concat(u,".").concat(m)]||d[m]||c[m]||i;return n?a.createElement(f,o(o({ref:t},p),{},{components:n})):a.createElement(f,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=d;var s={};for(var u in t)hasOwnProperty.call(t,u)&&(s[u]=t[u]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8693:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return o},metadata:function(){return s},toc:function(){return u},default:function(){return p}});var a=n(2122),r=n(9756),i=(n(7294),n(3905)),o={id:"desktop-feature-api",title:"Nimbus Feature API (JS)",slug:"/desktop-feature-api"},s={unversionedId:"desktop-feature-api",id:"desktop-feature-api",isDocsHomePage:!1,title:"Nimbus Feature API (JS)",description:"This guide will help you use the Nimbus Feature API in Desktop Firefox to run experiments, set values remotely, and manage user preferences. If you are familiar with Normandy and are trying to migrate a feature, you may want to check out the Migration Guide for Pref Experiments.",source:"@site/docs/desktop-feature-api.md",sourceDirName:".",slug:"/desktop-feature-api",permalink:"/desktop-feature-api",editUrl:"https://github.com/mozilla/experimenter-docs/edit/main/docs/desktop-feature-api.md",version:"current",frontMatter:{id:"desktop-feature-api",title:"Nimbus Feature API (JS)",slug:"/desktop-feature-api"},sidebar:"sidebar",previous:{title:"Testing on mobile",permalink:"/android-frontend-testing"},next:{title:"Migration Guide (JS)",permalink:"/desktop-migration-guide"}},u=[{value:"About Nimbus Features",id:"about-nimbus-features",children:[]},{value:"Configuration sources",id:"configuration-sources",children:[]},{value:"Registering a new feature",id:"registering-a-new-feature",children:[]},{value:"Importing the Feature API",id:"importing-the-feature-api",children:[]},{value:"API Reference Guide",id:"api-reference-guide",children:[{value:"<code>isEnabled()</code>",id:"isenabled",children:[]},{value:"<code>getValue()</code>",id:"getvalue",children:[]},{value:"<code>recordExposureEvent()</code>",id:"recordexposureevent",children:[]},{value:"<code>ready()</code>",id:"ready",children:[]},{value:"<code>onUpdate()</code>",id:"onupdate",children:[]},{value:"<code>off()</code>",id:"off",children:[]}]}],l={toc:u};function p(e){var t=e.components,n=(0,r.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,a.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"This guide will help you use the Nimbus Feature API in Desktop Firefox to run experiments, set values remotely, and manage user preferences. If you are familiar with Normandy and are trying to migrate a feature, you may want to check out the ",(0,i.kt)("a",{parentName:"p",href:"desktop-migration-guide"},"Migration Guide for Pref Experiments"),"."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Your code must be able to import ",(0,i.kt)("inlineCode",{parentName:"p"},"ExperimentAPI.jsm")," in the parent process or a privileged child process. We do not currently support a C++/Rust API."))),(0,i.kt)("h2",{id:"about-nimbus-features"},"About Nimbus Features"),(0,i.kt)("p",null,"In the Nimbus ecosystem, a ",(0,i.kt)("inlineCode",{parentName:"p"},"feature")," is an area of code instrumented for experiments and remote configuration. It can be as small as a single function or as complex as a whole about: page. Some examples:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"aboutwelcome"),", The about:welcome page in Desktop"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"newtab"),", The about:newtab page in Desktop")),(0,i.kt)("p",null,"In your code, you will use the Nimbus SDK to access variables associated with those features. e.g."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const { screens, skipFocus } = NimbusFeatures.aboutwelcome.getValue();\n")),(0,i.kt)("h2",{id:"configuration-sources"},"Configuration sources"),(0,i.kt)("p",null,"The Nimbus Feature API will return the correct configuration for a feature given a few different inputs ",(0,i.kt)("strong",{parentName:"p"},"in this order"),":"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"End-user-setting"),": If the ",(0,i.kt)("em",{parentName:"li"},"user branch")," of any preferences in the manifest are set, this will override experiment values or defaults. We believe this is important to respect user choice."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Experiment value"),": Next, we check if a Nimbus experiment is activated that changes the feature."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Remotely-configured value"),": If no experiment is set, we check if there is a remotely-defined value. This is a mechanism that allows us to roll-out changes quickly between releases."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Local default"),": Finally, we will return the ",(0,i.kt)("em",{parentName:"li"},"default branch")," of preferences in the manifest, if they are defined in ",(0,i.kt)("a",{parentName:"li",href:"https://searchfox.org/mozilla-central/source/browser/app/profile/firefox.js"},"firefox.js"),".")),(0,i.kt)("h2",{id:"registering-a-new-feature"},"Registering a new feature"),(0,i.kt)("p",null,"To register a new feature, you will need to choose an identifier and add it to the manifest in ",(0,i.kt)("a",{parentName:"p",href:"https://searchfox.org/mozilla-central/source/toolkit/components/nimbus/ExperimentAPI.jsm"},"ExperimentAPI.jsm"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'// In ExperimentAPI.jsm\n\nconst MANIFEST = {\n  // Our feature name\n  aboutwelcome: {\n    description: "The about:welcome page",\n    // This is a short-form for an "enabled" property\n    enabledFallbackPref: "browser.aboutwelcome.enabled",\n    variables: {\n      // Additional (optional) values that we can control\n      // The name of these variables is up to you\n      skipFocus: {\n        type: "boolean",\n        fallbackPref: "browser.aboutwelcome.skipFocus",\n      },\n    },\n  },\n};\n\n// In firefox.js\npref("browser.aboutwelcome.enable", true);\npref("skipFocus", false);\n')),(0,i.kt)("h2",{id:"importing-the-feature-api"},"Importing the Feature API"),(0,i.kt)("p",null,"Import the ",(0,i.kt)("inlineCode",{parentName:"p"},"NimbusFeatures")," module:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'XPCOMUtils.defineLazyModuleGetters(this, {\n  NimbusFeatures: "resource://nimbus/ExperimentAPI.jsm",\n});\n')),(0,i.kt)("h2",{id:"api-reference-guide"},"API Reference Guide"),(0,i.kt)("h3",{id:"isenabled"},(0,i.kt)("inlineCode",{parentName:"h3"},"isEnabled()")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"isEnabled({sendExposureEvent = false}): boolean")),(0,i.kt)("p",null,'Returns a value representing the "enabled" state of the feature. You can optionally send an exposure event when the function is called.'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const isEnabled = NimbusFeatures.myFeature.isEnabled();\n")),(0,i.kt)("h3",{id:"getvalue"},(0,i.kt)("inlineCode",{parentName:"h3"},"getValue()")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"getValue({sendExposureEvent = false}): FeatureValue")),(0,i.kt)("p",null,"Returns the value of all feature variables. You can optionally send an exposure event when the function is called."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const { foo, bar } = NimbusFeatures.myFeature.getValue({\n  sendExposureEvent: true,\n});\n")),(0,i.kt)("h3",{id:"recordexposureevent"},(0,i.kt)("inlineCode",{parentName:"h3"},"recordExposureEvent()")),(0,i.kt)("p",null,"Use this to manually send an exposure event. Alternatively, you can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"sendExposureEvent")," option for ",(0,i.kt)("inlineCode",{parentName:"p"},"isEnabled"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"getValue")," (see above)."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"NimbusFeatures.myFeature.recordExposureEvent();\n")),(0,i.kt)("h3",{id:"ready"},(0,i.kt)("inlineCode",{parentName:"h3"},"ready()")),(0,i.kt)("p",null,"Wait for the remote experiment and defaults stores to be synced before checking values."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"await NimbusFeatures.myFeature.ready();\nconst { foo } = NimbusFeatures.myFeature.getValue();\n")),(0,i.kt)("h3",{id:"onupdate"},(0,i.kt)("inlineCode",{parentName:"h3"},"onUpdate()")),(0,i.kt)("p",null,"Listen for changes, include to remote defaults or pref values."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"NimbusFeatures.myFeature.onUpdate(() => {\n  const newValue = NimbusFeatures.myFeature.getValue();\n  updateUI(newValue);\n});\n")),(0,i.kt)("h3",{id:"off"},(0,i.kt)("inlineCode",{parentName:"h3"},"off()")),(0,i.kt)("p",null,"Stop listening for changes."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"NimbusFeatures.myFeature.onUpdate(aListener);\n\n// Later\nNimbusFeatures.myFeature.off(aListener);\n")))}p.isMDXComponent=!0}}]);