(self.webpackChunkexperimenter_docs=self.webpackChunkexperimenter_docs||[]).push([[634],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return p},kt:function(){return m}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),u=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=u(a),m=r,f=d["".concat(l,".").concat(m)]||d[m]||c[m]||i;return a?n.createElement(f,o(o({ref:t},p),{},{components:a})):n.createElement(f,o({ref:t},p))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var u=2;u<i;u++)o[u]=a[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},1817:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return l},toc:function(){return u},default:function(){return c}});var n=a(2122),r=a(9756),i=(a(7294),a(3905)),o={id:"desktop-feature-api",title:"Nimbus Feature API (JS)",slug:"/desktop-feature-api"},s=void 0,l={unversionedId:"desktop-feature-api",id:"desktop-feature-api",isDocsHomePage:!1,title:"Nimbus Feature API (JS)",description:"This guide will help you use the Nimbus Feature API in Desktop Firefox to run experiments, set values remotely, and manage user preferences. If you are familiar with Normandy and are trying to migrate a feature, you may want to check out the Migration Guide for Pref Experiments.",source:"@site/docs/desktop-feature-api.md",sourceDirName:".",slug:"/desktop-feature-api",permalink:"/desktop-feature-api",editUrl:"https://github.com/mozilla/experimenter-docs/edit/main/docs/desktop-feature-api.md",tags:[],version:"current",frontMatter:{id:"desktop-feature-api",title:"Nimbus Feature API (JS)",slug:"/desktop-feature-api"},sidebar:"sidebar",previous:{title:"Testing the preview flow on iOS",permalink:"/ios-preview-testing"},next:{title:"Nimbus Feature API (Platform)",permalink:"/platform-feature-api"}},u=[{value:"API changes in Firefox 90",id:"api-changes-in-firefox-90",children:[]},{value:"About the Feature API",id:"about-the-feature-api",children:[{value:"Can I use this?",id:"can-i-use-this",children:[]},{value:"What is a feature?",id:"what-is-a-feature",children:[]}]},{value:"Configuration sources",id:"configuration-sources",children:[]},{value:"Registering a new feature",id:"registering-a-new-feature",children:[]},{value:"Importing the Feature API",id:"importing-the-feature-api",children:[]},{value:"API Reference Guide",id:"api-reference-guide",children:[{value:"<code>isEnabled()</code>",id:"isenabled",children:[]},{value:"<code>getVariable()</code>",id:"getvariable",children:[]},{value:"<code>getAllVariables()</code>",id:"getallvariables",children:[]},{value:"<code>recordExposureEvent()</code>",id:"recordexposureevent",children:[]},{value:"<code>ready()</code>",id:"ready",children:[]},{value:"<code>onUpdate()</code>",id:"onupdate",children:[]},{value:"<code>off()</code>",id:"off",children:[]}]}],p={toc:u};function c(e){var t=e.components,a=(0,r.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"This guide will help you use the Nimbus Feature API in Desktop Firefox to run experiments, set values remotely, and manage user preferences. If you are familiar with Normandy and are trying to migrate a feature, you may want to check out the ",(0,i.kt)("a",{parentName:"p",href:"desktop-migration-guide"},"Migration Guide for Pref Experiments"),"."),(0,i.kt)("h3",{id:"api-changes-in-firefox-90"},"API changes in Firefox 90"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\ud83c\udd95 Added a ",(0,i.kt)("a",{parentName:"li",href:"#getvariable"},(0,i.kt)("inlineCode",{parentName:"a"},"getVariable()"))," API that optimizes accessing single variables."),(0,i.kt)("li",{parentName:"ul"},"\ud83c\udd95 Added an ",(0,i.kt)("inlineCode",{parentName:"li"},"isEarlyStartup")," option in the manifest. Use this if you need to cache values for early synchronous access.")),(0,i.kt)("h2",{id:"about-the-feature-api"},"About the Feature API"),(0,i.kt)("h3",{id:"can-i-use-this"},"Can I use this?"),(0,i.kt)("p",null,"As of Firefox 90, your can use the Desktop Nimbus Feature API if your code is in Javascript and can import ",(0,i.kt)("inlineCode",{parentName:"p"},"ExperimentAPI.jsm")," in the parent process or a privileged child process. We ",(0,i.kt)("em",{parentName:"p"},"do")," support First run experiments on Windows, holdbacks, and an early-stage implementation of rollouts"),(0,i.kt)("p",null,"If you have a usecase that isn't supported, please reach out in #ask-experimenter on Slack."),(0,i.kt)("h3",{id:"what-is-a-feature"},"What is a feature?"),(0,i.kt)("p",null,"In the Nimbus ecosystem, a ",(0,i.kt)("inlineCode",{parentName:"p"},"feature")," is an area of code instrumented for experiments and remote configuration. It can be as small as a single function or as complex as a whole about: page. Some examples:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"aboutwelcome"),", The about:welcome page in Desktop"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"newtab"),", The about:newtab page in Desktop")),(0,i.kt)("p",null,"In your code, you will use the Nimbus SDK to access variables associated with those features. e.g."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const { screens, skipFocus } = NimbusFeatures.aboutwelcome.getAllVariables();\n")),(0,i.kt)("h2",{id:"configuration-sources"},"Configuration sources"),(0,i.kt)("p",null,"The Nimbus Feature API will return the correct configuration for a feature given a few different inputs ",(0,i.kt)("strong",{parentName:"p"},"in this order"),":"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"End-user-setting"),": If the ",(0,i.kt)("em",{parentName:"li"},"user branch")," of any preferences in the manifest are set, this will override experiment values or defaults. We believe this is important to respect user choice."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Experiment value"),": Next, we check if a Nimbus experiment is activated that changes the feature."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Remotely-configured value"),": If no experiment is set, we check if there is a remotely-defined value. This is a mechanism that allows us to roll-out changes quickly between releases."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Local default"),": Finally, we will return the ",(0,i.kt)("em",{parentName:"li"},"default branch")," of preferences in the manifest, if they are defined in ",(0,i.kt)("a",{parentName:"li",href:"https://searchfox.org/mozilla-central/source/browser/app/profile/firefox.js"},"firefox.js"),".")),(0,i.kt)("h2",{id:"registering-a-new-feature"},"Registering a new feature"),(0,i.kt)("p",null,"To register a new feature, you will need to choose an identifier and add it to the manifest in ",(0,i.kt)("a",{parentName:"p",href:"https://searchfox.org/mozilla-central/source/toolkit/components/nimbus/FeatureManifest.js"},"FeatureManifest.js"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'// In FeatureManifest.js\n\nconst MANIFEST = {\n  // Our feature name\n  aboutwelcome: {\n    description: "The about:welcome page",\n    // Include this if you need sychronous access / very early access at startup\n    isEarlyStartup: true,\n    variables: {\n      // Additional (optional) values that we can control\n      // The name of these variables is up to you\n      enabled: {\n        type: "boolean",\n        fallbackPref: "browser.aboutwelcome.enabled",\n      },\n      skipFocus: {\n        type: "boolean",\n      },\n    },\n  },\n};\n\n// In firefox.js\npref("browser.aboutwelcome.enabled", true);\n')),(0,i.kt)("h2",{id:"importing-the-feature-api"},"Importing the Feature API"),(0,i.kt)("p",null,"Import the ",(0,i.kt)("inlineCode",{parentName:"p"},"NimbusFeatures")," module:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'XPCOMUtils.defineLazyModuleGetters(this, {\n  NimbusFeatures: "resource://nimbus/ExperimentAPI.jsm",\n});\n')),(0,i.kt)("h2",{id:"api-reference-guide"},"API Reference Guide"),(0,i.kt)("h3",{id:"isenabled"},(0,i.kt)("inlineCode",{parentName:"h3"},"isEnabled()")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"isEnabled({sendExposureEvent = false}): boolean")),(0,i.kt)("p",null,"Short form for ",(0,i.kt)("inlineCode",{parentName:"p"},'.getVariable("enabled")')),(0,i.kt)("p",null,"Note that you should have an ",(0,i.kt)("inlineCode",{parentName:"p"},"enabled")," property defined in the manifest if you plan to use this."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const isEnabled = NimbusFeatures.myFeature.isEnabled();\n")),(0,i.kt)("h3",{id:"getvariable"},(0,i.kt)("inlineCode",{parentName:"h3"},"getVariable()")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"getVariable(variableName: string, {sendExposureEvent = false}): FeatureValue")),(0,i.kt)("p",null,"Returns the value of a single feature variable. You can optionally send an exposure event when the function is called."),(0,i.kt)("p",null,"Warning: ",(0,i.kt)("strong",{parentName:"p"},"This function will throw in Nightly and CI build")," if you do not define ",(0,i.kt)("inlineCode",{parentName:"p"},"variableName")," in the Nimbus manifest."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'const foo = NimbusFeatures.myFeature.getVariable("foo");\n\nconst bar = NimbusFeatures.myFeature.getVariable("bar", {\n  sendExposureEvent: true,\n});\n\n// notAVariable is not defined in the manifest, so this will throw in CI\nconst baz = NimbusFeatures.myFeature.getVariable("notAVariable");\n')),(0,i.kt)("h3",{id:"getallvariables"},(0,i.kt)("inlineCode",{parentName:"h3"},"getAllVariables()")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"getAllVariables({sendExposureEvent = false, defaultValues}): FeatureValue")),(0,i.kt)("p",null,"Returns the value of all variables for a feature. Note that ",(0,i.kt)("strong",{parentName:"p"},"variables will be merged beftween sources"),"."),(0,i.kt)("p",null,"If ",(0,i.kt)("inlineCode",{parentName:"p"},"options.defaultValues")," is defined, it will be preferred before default branch fallback values but after experiment, remote, and user-set preference values."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const { foo, bar } = NimbusFeatures.myFeature.getAllVariables({\n  sendExposureEvent: true,\n  defaultValues: { foo: true, bar: false },\n});\n")),(0,i.kt)("h3",{id:"recordexposureevent"},(0,i.kt)("inlineCode",{parentName:"h3"},"recordExposureEvent()")),(0,i.kt)("p",null,"Use this to send an exposure event. By defualt this will send one exposure event per function call, but you can add an options object of ",(0,i.kt)("inlineCode",{parentName:"p"},"{once: true}")," to only send it once per session."),(0,i.kt)("p",null,"Note that you should add an ",(0,i.kt)("inlineCode",{parentName:"p"},"exposureDescription")," to the manifest describing when/how this event is sent. "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"NimbusFeatures.myFeature.recordExposureEvent();\n\n// Only sends once per session, even if this function is called muliple times\nNimbusFeatures.myFeature.recordExposureEvent({once: true});\n")),(0,i.kt)("h3",{id:"ready"},(0,i.kt)("inlineCode",{parentName:"h3"},"ready()")),(0,i.kt)("p",null,"Wait for the remote experiment and defaults stores to be synced before checking values."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"await NimbusFeatures.myFeature.ready();\nconst { foo } = NimbusFeatures.myFeature.getAllVariables();\n")),(0,i.kt)("h3",{id:"onupdate"},(0,i.kt)("inlineCode",{parentName:"h3"},"onUpdate()")),(0,i.kt)("p",null,"Listen for changes, include to remote defaults or pref values."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"NimbusFeatures.myFeature.onUpdate(() => {\n  const newValue = NimbusFeatures.myFeature.getAllVariables();\n  updateUI(newValue);\n});\n")),(0,i.kt)("h3",{id:"off"},(0,i.kt)("inlineCode",{parentName:"h3"},"off()")),(0,i.kt)("p",null,"Stop listening for changes."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"NimbusFeatures.myFeature.onUpdate(aListener);\n\n// Later\nNimbusFeatures.myFeature.off(aListener);\n")))}c.isMDXComponent=!0}}]);